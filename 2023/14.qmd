---
format: html
---

```{r}
#| label: setup
#| include: false
library(tidyverse)
```

## Input

```{r}
read_lines(
"O....#....
O.OO#....#
.....##...
OO.#O....O
.O.....O#.
O.#..O.#.#
..O..#O..O
.......O..
#....###..
#OO..#....") -> input
#input <- read_lines("input/14")
input |> 
 str_replace_all(c("\\." = "0", "#" = "1", "O" = 2)) |> 
    tibble(x = _) |> 
    adventdrob::grid_matrix(var = x) -> mat
```

Main process, shift by columns

```{r}

rotate_90d_right <- function(mat) {
  # transpose then flip
  m <- t(mat)
  m[, ncol(m):1]
}

rotate_90d_left <- function(mat) {
  # transpose then flip
  m <- t(mat)
  m[nrow(m):1, ]
}

shift_mirrors <- function(vec) {

  # pre-fill res vector with solid rock
  res <- vector(mode = "integer", length = length(vec))
  res[which(vec == 1)] <- 1
  
  # no solid rocks, cluster north
  if (length(which(vec == 1)) == 0) {
    res[seq_along(which(vec == 2))] <- 2
    return(res)
  }
  last_i <- 1
  # split vector by solid rock
  if (which(vec == 1)[length(which(vec == 1))] < length(vec)) {
    # add last part if rock is not ending vec
    rock_pos <- c(which(vec == 1), length(vec))
    # edge case, 99 is rock but 100 is mirror, no shift but must be reported
    if ((which(vec == 1)[length(which(vec == 1))] == (length(vec) - 1)) & vec[length(vec)] == 2) {
      res[length(vec)] <- 2
    }
  } else {
    rock_pos <- which(vec == 1)
  }
  for (i in rock_pos) {
    # if rock is starting nothing to do
    if (i == 1) {
      last_i <- i + 1
      next
    }
    # no space between rocks, nothing to shift
    if (length(last_i:i) == 1) {
      last_i <- i + 1
      next
    }
    # how many mirrors to move north
    nb_mir <- length(which(vec[last_i:i] == 2))
    #message("lasti ", last_i, " i ", i, " mirros: ", nb_mir)
    if (nb_mir > 0) res[last_i:(nb_mir + last_i - 1)] <- 2
    last_i <- i + 1
  }
  res
}

rotate_and_shift <- function(mat, round = 1, part2 = FALSE) {
  mat |> 
    rotate_90d_right() |> 
    apply(MARGIN = 2, FUN = shift_mirrors)
}


moved <- apply(mat, 2, shift_mirrors)

```

Counting points

```{r}
(apply(moved, 1, \(x) length(which(x == 2))) * nrow(moved):1) |> reduce(`+`)
```

105621 too low. Issue with columns 29 42 thanks to Tanguy solution (105623)


## Part 2


```{r}
# step zero, rotate once left so we start by shifting North
ongoing <- rotate_90d_left(mat)
aim <- 1e6
current_load <- vector(mode = "integer", length = aim)
for (i in seq_len(aim)) {
  if (i %% 10000 == 0) message("treating iteration: ", i, " (", round((i / aim) * 100, 2),"%)")
  ongoing <- rotate_and_shift(ongoing)
  current_load[i] <- (apply(ongoing, 1, \(x) length(which(x == 2))) * nrow(ongoing):1) |> 
    reduce(`+`)
}
ongoing

(apply(ongoing, 1, \(x) length(which(x == 2))) * nrow(ongoing):1) |> reduce(`+`)
```

```{r}
library(gganimate)
tibble(y = current_load,
       dir = rep(c("N", "W", "S", "E"), 1e6 / 4),
       x = seq_len(1e6)) |> #count(x, dir, sort = TRUE)
  head(1000) |> 
  ggplot(aes(x, y, colour = dir)) +
  geom_line() +
  transition_reveal(x) +
  theme_minimal() +
  theme(legend.position = "top") +
  labs(x = "Iteration",
       y = "Current load",
       title = "AoC day14, part2",
       subtitle = "iteration: {frame_along}",
       colour = "Shifting\ndirection") 
anim_save("2023/day14_part2.gif")
```



## Plotting part 1


```{r}
library(gganimate)
bind_rows(
  tibble(x = 1:nrow(moved),
         y = apply(moved, 1, \(x) which(x == 2)),
         type = "mirror",
         t = 2),
  tibble(x = 1:nrow(moved),
         y = apply(moved, 1, \(x) which(x == 1)),
         type = "rocks",
         t = 2),
  tibble(x = 1:nrow(mat),
         y = apply(mat, 1, \(x) which(x == 2)),
         type = "mirror",
         t = 1),
  tibble(x = 1:nrow(mat),
         y = apply(mat, 1, \(x) which(x == 1)),
         type = "rocks",
         t = 1)) |> 
  mutate(t = factor(t, labels = c("intial", "shifted North"))) |> 
  unnest(y) |> 
  ggplot(aes(x = factor(y), y = -x, shape = type, colour = type)) +
  geom_point(size = 6) +
  transition_states(t) +
  scale_colour_manual(values = c("grey", "black")) +
  scale_shape_manual(values = c(9, 15)) +
  theme_void() +
  theme(legend.position = "none",
        panel.grid.major.x = element_line(colour = "grey80"),
        panel.grid.minor.x = element_line(colour = "grey80")) +
  labs(title = "{closest_state}") -> miranim
animate(miranim)
anim_save("day14.gif")
 # facet_wrap(vars(t), ncol = 1)
```



