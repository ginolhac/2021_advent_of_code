---
format: html
---

```{r}
#| label: setup
#| include: false
library(tidyverse)
```

## Input

```{r}
read_lines(
"O....#....
O.OO#....#
.....##...
OO.#O....O
.O.....O#.
O.#..O.#.#
..O..#O..O
.......O..
#....###..
#OO..#....") -> input
#input <- read_lines("input/14")
input |> 
 str_replace_all(c("\\." = "0", "#" = "1", "O" = 2)) |> 
    tibble(x = _) |> 
    adventdrob::grid_matrix(var = x) -> mat
```

Main process, shift by columns

```{r}

shift_mirrors <- function(vec) {
  # pre-fill res vector with solid rock
  res <- vector(mode = "integer", length = length(vec))
  res[which(vec == 1)] <- 1
  
  # no solid rocks, cluster north
  if (length(which(vec == 1)) == 0) {
    res[seq_along(which(vec == 2))] <- 2
    return(res)
  }
  last_i <- 1
  # split vector by solid rock
  if (which(vec == 1)[length(which(vec == 1))] < length(vec)) {
    # add last part if rock is not ending vec
    rock_pos <- c(which(vec == 1), length(vec))
    # edge case, 99 is rock but 100 is mirror, no shift but must be reported
    if ((which(vec == 1)[length(which(vec == 1))] == (length(vec) - 1)) & vec[length(vec)] == 2) {
      res[length(vec)] <- 2
    }
  } else {
    rock_pos <- which(vec == 1)
  }
  for (i in rock_pos) {
    # if rock is starting nothing to do
    if (i == 1) {
      last_i <- i + 1
      next
    }
    # no space between rocks, nothing to shift
    if (length(last_i:i) == 1) {
      last_i <- i + 1
      next
    }
    # how many mirrors to move north
    nb_mir <- length(which(vec[last_i:i] == 2))
    #message("lasti ", last_i, " i ", i, " mirros: ", nb_mir)
    if (nb_mir > 0) res[last_i:(nb_mir + last_i - 1)] <- 2
    last_i <- i + 1
  }
  res
}

moved <- apply(mat, 2, shift_mirrors)

```
counting points
```{r}
(apply(moved, 1, \(x) length(which(x == 2))) * nrow(moved):1) |> reduce(`+`)
```

105621 too low. Issue with columns  29 42 thanks to Tanguy solution (105623)


## Plotting


```{r}
library(gganimate)
bind_rows(
  tibble(x = 1:nrow(moved),
         y = apply(moved, 1, \(x) which(x == 2)),
         type = "mirror",
         t = 2),
  tibble(x = 1:nrow(moved),
         y = apply(moved, 1, \(x) which(x == 1)),
         type = "rocks",
         t = 2),
  tibble(x = 1:nrow(mat),
         y = apply(mat, 1, \(x) which(x == 2)),
         type = "mirror",
         t = 1),
  tibble(x = 1:nrow(mat),
         y = apply(mat, 1, \(x) which(x == 1)),
         type = "rocks",
         t = 1)) |> 
  mutate(t = factor(t, labels = c("intial", "shifted North"))) |> 
  unnest(y) |> 
  ggplot(aes(x = factor(y), y = -x, shape = type, colour = type)) +
  geom_point(size = 6) +
  transition_states(t) +
  scale_colour_manual(values = c("grey", "black")) +
  scale_shape_manual(values = c(9, 15)) +
  theme_void() +
  theme(legend.position = "none",
        panel.grid.major.x = element_line(colour = "grey80"),
        panel.grid.minor.x = element_line(colour = "grey80")) +
  labs(title = "{closest_state}") -> miranim
animate(miranim)
anim_save("day14.gif")
 # facet_wrap(vars(t), ncol = 1)
```



