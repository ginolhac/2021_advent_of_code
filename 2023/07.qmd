---
format: html
---

```{r}
#| label: setup
#| include: false
library(tidyverse)
```

## Input

```{r}
#| label: readin-input

read_lines(
"32T3K 765
T55J5 684
KK677 28
KTJJT 220
QQQJA 483") -> input
input <- read_lines("input/07")
```


## Part 1

```{r}
#| label: helpers

items <- c("T", "J", "Q", "K", "9", "8", "7", "6", "5", "4", "3", "2")

convert_cards <- function(figures) {
  case_match(figures,
    "T" ~ "10",
    "J" ~ "11",
    "Q" ~ "12",
    "K" ~ "13",
    "A" ~ "14",
    "9" ~ "9",
    "8" ~ "8",
    "7" ~ "7",
    "6" ~ "6",
    "5" ~ "5",
    "4" ~ "4",
    "3" ~ "3",
    "2" ~ "2",
    .ptype = character(),
    .default = NA
  )
}

count_cards <- function(cards) {
  cts <- str_count(cards, items)
  names(cts) <- convert_cards(items)
  cts
}

scoring <- function(counts) {
  # Five of a kind
  if (any(counts %in% 5)) {
    #message("Five ", names(counts)[which(counts %in% 5)])
    return(50)
  }
  # Four of a kind
  if (any(counts %in% 4)) {
    #message("Four ", names(counts)[which(counts %in% 4)])
    return(40)
  }
  # Full house
  if (any(counts %in% 3) & any(counts %in% 2)) {
     #message("Full house ", names(counts)[which(counts %in% 3)])
    return(30)
  }
  # Three of a kind
  if (any(counts %in% 3)) {
     #message("Three ", names(counts)[which(counts %in% 3)])
    return(20)
  }
  # Two pairs
  if (sum(counts %in% 2) == 2) {
     #message("Two pairs ", names(counts)[which(counts %in% 2)])
    return(10)
  }
  # One pair
  if (sum(counts %in% 2) == 1) {
     #message("One pair ", names(counts)[which(counts %in% 2)])
    return(5)
  }
  # High card
  0
}

scoring(c(`1` = 4, `2` = 2, `3` = 3, `4` = 5))
scoring(c(`1` = 4, `2` = 2, `3` = 3, `4` = 0))
scoring(c(`1` = 0, `2` = 2, `3` = 3, `4` = 0))

solve_ties <- function(rank, tib) {
  # no ties
  if (nrow(tib) == 1L) return(rank)
  # ties
  tibble(id = tib$hands) |>
    mutate(card = map(id, \(x) str_split_1(x, "") |> 
                        convert_cards() |> 
                        as.numeric()),
           id = paste0(id, "_", row_number())) |> 
    column_to_rownames(var = "id") |> 
    unnest_wider(card, names_sep = "_") |> 
    # rows are always the 5 cards
    # columns are all hands that are ties
    t() -> mat
  apply(mat, 1, rank) |> rowSums() / 1000 + rank
}
```

```{r}
#| label: part1
tibble(x = input) |> 
  separate(x, into = c("hands", "bid"), sep = " ") |> 
  mutate(chands = map(hands, count_cards),
         scores = map_int(chands, scoring),
         rank =  dense_rank(scores)) |> 
  # must rank the ties now
  nest(.by = rank) |> 
  mutate(rank2 = map2(rank, data, \(x, y) solve_ties(rank = x, tib = y))) |> 
  unnest(c(rank2, data)) |> 
  mutate(rank3 = dense_rank(rank2),
         winnings = as.numeric(bid) * rank3) |> 
  summarise(total = sum(winnings))

```

Tanguy solution

```{r}
tibble(x = input) |> 
  separate(x, into = c("hands", "bid"), sep = " ") |> 
  mutate(chands = map(hands, count_cards),
         hands2 = str_replace_all(hands, c("T" = "B", "A" = "Z", "K" = "W") |> 
                                    sort()),
         scores = map_int(chands, scoring),
         rank =  dense_rank(scores)) |> 
  arrange(rank, hands2) |> 
  mutate(rank2 = row_number(),
         winnings = as.numeric(bid) * rank2) |> 
  summarise(total = sum(winnings))
  
```

248559379


```{r}
sort(c("T", "A", "J", "Q", "K", "9", "8", "7", "6", "5", "4", "3", "2") |> 
       str_replace_all(c("T" = "B", "A" = "Z", "K" = "W")))
```




