---
format: html
---

```{r}
#| label: setup
#| include: false
library(tidyverse)
```

## Input

```{r}
scan("input/15_example", what = "character", sep = ",") -> input
scan("input/15", what = "character", sep = ",") -> input
```



```{r}
test <- "HASH"

compute_hash <- function(string) {
  cur_val <- 0
  for (s in str_split_1(string, "")) {
    cur_val <- ((cur_val + utf8ToInt(s)) * 17) %% 256
    #message(s, " ", utf8ToInt(s), " val ", cur_val)
  }
  cur_val
}

compute_hash(test)
# expect 52

```


## Part 1

```{r}
map_int(input, compute_hash) |> sum()
```


## Part 2

**Hashmap** can be using base R `new.env(hash = TRUE)` but here testing the `hashtab()` introduced in R 4.2.0

As package, [`{fatmap}`](https://github.com/r-lib/fastmap) seems relevant

```{r}
# 0 to 255, so 256 since no zero in R
boxes <- vector(mode = "list", length = 256) |> 
  lapply(hashtab)

for (el in input) {
  index <- str_extract(el, "^[a-z]+")
  hash <- compute_hash(index)
  action <- str_extract(el, "[=\\-]")
  focal_length <- str_extract(el, "=(\\d+)$", group = 1)
  message("---- ", el, " box:",hash, " index: ", index, " ac ", action, " focal ", focal_length)
  if (action == "=" && is.null(gethash(boxes[[hash + 1]], index))) {
    sethash(boxes[[hash + 1]], index, focal_length)
    message("init  ", index, " in ", hash + 1)
  #} else if (action == "=" && length(boxes[[hash + 1]]) >= 1) {
   # boxes[[hash + 1]] <- c(boxes[[hash + 1]], setNames(focal_length, index))
    #message("adding  ", index, " in ", hash + 1)
  } else if (!is.null(gethash(boxes[[hash + 1]], index)) && action == "-") {
    message("removing  ", index, " in ", hash + 1)
    remhash(boxes[[hash + 1]], index)
  } else if (action == "=" && !is.null(gethash(boxes[[hash + 1]], index))) {
    message("updating  ", index, " in ", hash + 1)
    sethash(boxes[[hash + 1]], index, focal_length)
  }   else {
    message("issue: ", el, " hash ", hash, " index: ", index, " ac ", action, " focal ", focal_length)
  }
  print(hashkeys(boxes[[4]]))
}


```


```{r}
# from hashtab help page
hashkeys <- function(h) {
  val <- vector("list", numhash(h))
  idx <- 0
  maphash(h, function(k, v) { 
    idx <<- idx + 1
    val[idx] <<- list(k)
  })
  val
}

# compute focusing power
for (i in seq_along(boxes)) {
  ht <- hashkeys(boxes[[i]])
  if (length(ht) == 0) next
  print(ht)
}
```

